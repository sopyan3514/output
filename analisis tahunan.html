<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Tahunan Produksi - Flexible Packaging (Meter)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --success: #27ae60;
            --warning: #f39c12;
            --dark: #2c3e50;
            --info: #17a2b8;
            --purple: #9b59b6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--light);
        }
        
        .logo h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .logo span {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 6px;
        }
        
        .year-selector select {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            background: white;
            color: var(--primary);
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .tab-btn {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-btn:hover {
            background-color: #f8f9fa;
        }
        
        .tab-btn.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Summary Dashboard */
        .summary-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card.total {
            border-top: 5px solid var(--primary);
        }
        
        .summary-card.efficiency {
            border-top: 5px solid var(--success);
        }
        
        .summary-card.machine {
            border-top: 5px solid var(--warning);
        }
        
        .summary-card.reject {
            border-top: 5px solid var(--accent);
        }
        
        .summary-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .summary-value {
            font-size: 2.8rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .summary-label {
            color: #666;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .summary-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--accent);
        }
        
        .trend-neutral {
            color: #666;
        }
        
        /* Chart Container */
        .chart-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-card.full-width {
            grid-column: span 2;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Form Input Data */
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .required::after {
            content: " *";
            color: var(--accent);
        }
        
        /* Table Section */
        .table-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
        }
        
        .search-container input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 250px;
        }
        
        /* Button Styles */
        .app-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-completed {
            background-color: #d5f4e6;
            color: var(--success);
        }
        
        .status-progress {
            background-color: #fff3cd;
            color: var(--warning);
        }
        
        .status-delayed {
            background-color: #f8d7da;
            color: var(--accent);
        }
        
        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            animation: toastSlideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success { background-color: var(--success); }
        .toast-error { background-color: var(--accent); }
        .toast-info { background-color: var(--secondary); }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .summary-dashboard,
            .chart-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-card.full-width {
                grid-column: span 2;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .summary-dashboard,
            .chart-container {
                grid-template-columns: 1fr;
            }
            
            .chart-card.full-width {
                grid-column: span 1;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .app-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-controls {
                width: 100%;
            }
            
            .search-container input {
                min-width: auto;
                flex: 1;
            }
        }
        
        /* Additional Styles */
        .progress-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .pagination-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            min-width: 40px;
            text-align: center;
        }
        
        .pagination-btn.active {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .data-count {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-bar"></i>
                    <div>
                        <h1>Analisis Tahunan Produksi</h1>
                        <span>Divisi Printing - PT. Kemasan Fleksibel Indonesia (Satuan Meter)</span>
                    </div>
                </div>
                <div class="year-selector">
                    <span>Tahun Analisis:</span>
                    <select id="year-select">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
            </div>
        </header>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-btn" data-tab="input-data">
                <i class="fas fa-plus-circle"></i> Input Data
            </button>
            <button class="tab-btn" data-tab="data-table">
                <i class="fas fa-table"></i> Data Produksi
            </button>
            <button class="tab-btn" data-tab="analysis">
                <i class="fas fa-chart-line"></i> Analisis
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="app-controls">
                <button class="btn btn-primary" id="btn-refresh">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="btn btn-success" id="btn-export-excel">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="btn btn-warning" id="btn-export-pdf">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
                <button class="btn btn-info" id="btn-comparison">
                    <i class="fas fa-chart-line"></i> Perbandingan Tahun
                </button>
                <button class="btn btn-danger" id="btn-reset-filters">
                    <i class="fas fa-filter"></i> Reset Filter
                </button>
            </div>
            
            <!-- Summary Dashboard -->
            <div class="summary-dashboard">
                <div class="summary-card total">
                    <div class="summary-icon" style="color: var(--primary);">
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <div class="summary-value" id="total-output-year">0</div>
                    <div class="summary-label">Total Output Tahunan</div>
                    <div class="summary-trend">
                        <span class="trend-up" id="output-trend">
                            <i class="fas fa-arrow-up"></i> 12%
                        </span>
                        <span>vs tahun lalu</span>
                    </div>
                </div>
                
                <div class="summary-card efficiency">
                    <div class="summary-icon" style="color: var(--success);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="summary-value" id="avg-efficiency">0%</div>
                    <div class="summary-label">Rata-rata Efisiensi</div>
                    <div class="summary-trend">
                        <span class="trend-up" id="efficiency-trend">
                            <i class="fas fa-arrow-up"></i> 5%
                        </span>
                        <span>vs tahun lalu</span>
                    </div>
                </div>
                
                <div class="summary-card machine">
                    <div class="summary-icon" style="color: var(--warning);">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="summary-value" id="top-machine">-</div>
                    <div class="summary-label">Mesin Terproduktif</div>
                    <div class="summary-trend">
                        <span id="machine-output">Output: 0 m</span>
                    </div>
                </div>
                
                <div class="summary-card reject">
                    <div class="summary-icon" style="color: var(--accent);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-value" id="reject-rate-year">0%</div>
                    <div class="summary-label">Tingkat Reject</div>
                    <div class="summary-trend">
                        <span class="trend-down" id="reject-trend">
                            <i class="fas fa-arrow-down"></i> 3%
                        </span>
                        <span>vs tahun lalu</span>
                    </div>
                </div>
            </div>
            
            <!-- Chart Section -->
            <div class="chart-container">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Output Produksi per Bulan</h2>
                        <select id="chart-type">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                        </select>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="monthly-output-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Distribusi per Mesin</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="machine-distribution-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-chart-line"></i> Trend Efisiensi</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="efficiency-trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Data Tab -->
        <div id="input-data" class="tab-content">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-plus-circle"></i> Input Data Produksi Baru</h2>
                    <span id="form-status">Mode: Tambah Data</span>
                </div>
                
                <form id="production-form">
                    <input type="hidden" id="edit-id" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="order-number" class="required">Nomor SPK</label>
                            <input type="text" id="order-number" placeholder="CON/2023/08/001" required>
                        </div>
                        <div class="form-group">
                            <label for="production-date" class="required">Tanggal Produksi</label>
                            <input type="date" id="production-date" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-name" class="required">Nama Produk</label>
                        <input type="text" id="product-name" placeholder="Pouch Stand-up 100ml" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="composition" class="required">Komposisi Material</label>
                        <textarea id="composition" rows="2" placeholder="PET 12 micron / AL 7 micron / PE 50 micron" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer">Nama Customer</label>
                            <input type="text" id="customer" placeholder="Nama Perusahaan Customer">
                        </div>
                        <div class="form-group">
                            <label for="machine" class="required">Mesin</label>
                            <select id="machine" required>
                                <option value="">Pilih Mesin</option>
                                <option value="Printing 1">Printing 1</option>
                                <option value="Printing 2">Printing 2</option>
                                <option value="Printing 3">Printing 3</option>
                                <option value="Printing 4">Printing 4</option>
                                <option value="Lamination 1">Lamination 1</option>
                                <option value="Lamination 2">Lamination 2</option>
                                <option value="Solventless 1">Solventless 1</option>
                                <option value="Solventless 2">Solventless 2</option>
                                <option value="Solventless 3">Solventless 3</option>
                                <option value="Extrusion 1">Extrusion 1</option>
                                <option value="Extrusion 2">Extrusion 2</option>
                                <option value="Extrusion 3">Extrusion 3</option>
                                <option value="Extrusion 4">Extrusion 4</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="target-quantity" class="required">Target Produksi (meter)</label>
                            <input type="number" id="target-quantity" placeholder="5000" min="1" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="actual-output" class="required">Output Aktual (meter)</label>
                            <input type="number" id="actual-output" placeholder="4750" min="0" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reject-quantity">Reject/Waste (meter)</label>
                            <input type="number" id="reject-quantity" placeholder="150" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="operator" class="required">Operator</label>
                            <input type="text" id="operator" placeholder="Nama Operator" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shift" class="required">Shift</label>
                            <select id="shift" required>
                                <option value="">Pilih Shift</option>
                                <option value="Pagi">Pagi (07.00 - 15.00)</option>
                                <option value="Sore">Sore (15.00 - 23.00)</option>
                                <option value="Malam">Malam (23.00 - 07.00)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status Produksi</label>
                            <select id="status">
                                <option value="completed">Selesai</option>
                                <option value="progress">Dalam Proses</option>
                                <option value="delayed">Terlambat</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Catatan Produksi</label>
                        <textarea id="notes" rows="3" placeholder="Catatan produksi (masalah mesin, bahan baku, kualitas, dll)"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Data
                        </button>
                        <button type="button" class="btn btn-warning" id="btn-cancel-edit" style="display: none;">
                            <i class="fas fa-times"></i> Batal Edit
                        </button>
                        <button type="button" class="btn btn-primary" id="btn-clear-form">
                            <i class="fas fa-eraser"></i> Kosongkan Form
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Quick Stats -->
            <div class="summary-dashboard">
                <div class="summary-card">
                    <div class="summary-icon" style="color: var(--secondary);">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="summary-value" id="total-data">0</div>
                    <div class="summary-label">Total Data Tersimpan</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon" style="color: var(--success);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-value" id="today-data">0</div>
                    <div class="summary-label">Data Hari Ini</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon" style="color: var(--warning);">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="summary-value" id="month-data">0</div>
                    <div class="summary-label">Data Bulan Ini</div>
                </div>
                
                <div class="summary-card">
                    <div class="summary-icon" style="color: var(--accent);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-value" id="pending-data">0</div>
                    <div class="summary-label">Data Pending</div>
                </div>
            </div>
        </div>
        
        <!-- Data Table Tab -->
        <div id="data-table" class="tab-content">
            <div class="table-section">
                <div class="table-header">
                    <h2><i class="fas fa-table"></i> Data Produksi</h2>
                    <div class="table-controls">
                        <div class="search-container">
                            <input type="text" id="search-input" placeholder="Cari data produksi...">
                            <button class="btn btn-primary btn-small" id="btn-search-data">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <select id="filter-data">
                            <option value="all">Semua Data</option>
                            <option value="today">Hari Ini</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                        </select>
                        <button class="btn btn-danger btn-small" id="btn-bulk-delete">
                            <i class="fas fa-trash"></i> Hapus Massal
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="data-production-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>No. Order</th>
                                <th>Tanggal</th>
                                <th>Produk</th>
                                <th>Target (m)</th>
                                <th>Aktual (m)</th>
                                <th>Efisiensi</th>
                                <th>Mesin</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="pagination-container">
                    <!-- Pagination akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="app-controls">
                <button class="btn btn-primary" id="btn-generate-analysis">
                    <i class="fas fa-calculator"></i> Generate Analisis
                </button>
                <button class="btn btn-success" id="btn-export-analysis">
                    <i class="fas fa-file-excel"></i> Export Analisis
                </button>
                <button class="btn btn-info" id="btn-forecast">
                    <i class="fas fa-chart-line"></i> Forecast Produksi
                </button>
            </div>
            
            <div class="chart-container">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Analisis Trend Tahunan</h2>
                        <select id="analysis-type">
                            <option value="output">Output Produksi</option>
                            <option value="efficiency">Efisiensi</option>
                            <option value="reject">Reject Rate</option>
                        </select>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="annual-trend-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-industry"></i> Analisis Mesin</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="machine-analysis-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h2 class="chart-title"><i class="fas fa-calendar-alt"></i> Seasonal Pattern</h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="seasonal-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Results -->
            <div class="table-section">
                <div class="table-header">
                    <h2><i class="fas fa-chart-pie"></i> Hasil Analisis</h2>
                </div>
                <div id="analysis-results">
                    <!-- Hasil analisis akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>Analisis Tahunan Produksi Flexible Packaging &copy; 2023 - PT. Kemasan Fleksibel Indonesia</p>
            <p>Versi 4.0 | Fungsionalitas 100% | Total Data: <span id="total-data-count">0</span> | Terakhir Update: <span id="last-update"></span></p>
        </footer>
    </div>
    
    <!-- Modal for Detail View -->
    <div class="modal" id="detail-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-detail-modal">&times;</button>
            <div class="modal-header">
                <h2>Detail Data Produksi</h2>
            </div>
            <div id="modal-detail-content">
                <!-- Detail data akan diisi oleh JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Modal for Year Comparison -->
    <div class="modal" id="comparison-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-comparison-modal">&times;</button>
            <div class="modal-header">
                <h2>Perbandingan Multi Tahun</h2>
            </div>
            <div class="chart-wrapper" style="height: 400px; margin-top: 20px;">
                <canvas id="multi-year-comparison-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Modal for Forecast -->
    <div class="modal" id="forecast-modal">
        <div class="modal-content">
            <button class="modal-close" id="close-forecast-modal">&times;</button>
            <div class="modal-header">
                <h2>Forecast Produksi</h2>
            </div>
            <div class="chart-wrapper" style="height: 400px; margin-top: 20px;">
                <canvas id="forecast-chart"></canvas>
            </div>
            <div style="margin-top: 20px;">
                <h3>Rekomendasi Produksi</h3>
                <div id="forecast-recommendations">
                    <!-- Rekomendasi akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;"></div>

    <script>
        // Konfigurasi Aplikasi Analisis Tahunan
        const CONFIG = {
            currentYear: new Date().getFullYear(),
            localStorageKey: 'production_data_full_v1',
            itemsPerPage: 10,
            efficiencyTarget: 90,
            rejectRateTarget: 3
        };
        
        // Data Aplikasi
        let productionData = [];
        let currentPage = 1;
        let selectedYear = CONFIG.currentYear;
        let selectedItems = new Set();
        let chartInstances = {};
        
        // Daftar Mesin
        const MACHINES = [
            "Printing 1", "Printing 2", "Printing 3", "Printing 4",
            "Lamination 1", "Lamination 2",
            "Solventless 1", "Solventless 2", "Solventless 3",
            "Extrusion 1", "Extrusion 2", "Extrusion 3", "Extrusion 4"
        ];
        
        // Inisialisasi Aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            initApplication();
        });
        
        function initApplication() {
            loadData();
            setupEventListeners();
            initializeForm();
            updateUI();
            showToast('Aplikasi siap digunakan!', 'success');
        }
        
        // Data Management
        function loadData() {
            const savedData = localStorage.getItem(CONFIG.localStorageKey);
            if (savedData) {
                productionData = JSON.parse(savedData);
                if (!Array.isArray(productionData)) {
                    productionData = [];
                }
            } else {
                generateSampleData();
            }
            updateDataCount();
        }
        
        function saveData() {
            localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(productionData));
            updateDataCount();
        }
        
        function generateSampleData() {
            productionData = [];
            const startDate = new Date(2023, 0, 1);
            
            for (let i = 1; i <= 50; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + Math.floor(Math.random() * 365));
                
                const target = 1000 + Math.random() * 9000;
                const actual = target * (0.85 + Math.random() * 0.15);
                const reject = actual * (0.01 + Math.random() * 0.03);
                const efficiency = (actual / target) * 100;
                
                let status = 'progress';
                if (efficiency >= 95) status = 'completed';
                else if (efficiency < 75) status = 'delayed';
                
                productionData.push({
                    id: i,
                    orderNumber: `CON/2023/${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}/${String(i).padStart(3, '0')}`,
                    date: date.toISOString().split('T')[0],
                    productName: `Produk ${i}`,
                    composition: "PET 12 micron / AL 7 micron / PE 50 micron",
                    customer: `Customer ${Math.floor(Math.random() * 10) + 1}`,
                    target: Math.round(target),
                    actual: Math.round(actual),
                    reject: Math.round(reject),
                    machine: MACHINES[Math.floor(Math.random() * MACHINES.length)],
                    operator: `Operator ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`,
                    shift: ['Pagi', 'Sore', 'Malam'][Math.floor(Math.random() * 3)],
                    status: status,
                    notes: Math.random() > 0.7 ? "Catatan produksi" : "",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
            
            saveData();
        }
        
        // Form Management
        function initializeForm() {
            // Set tanggal default ke hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('production-date').value = today;
            
            // Set shift berdasarkan waktu saat ini
            const hour = new Date().getHours();
            const shiftSelect = document.getElementById('shift');
            if (hour >= 7 && hour < 15) shiftSelect.value = "Pagi";
            else if (hour >= 15 && hour < 23) shiftSelect.value = "Sore";
            else shiftSelect.value = "Malam";
        }
        
        function clearForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('production-form').reset();
            document.getElementById('form-status').textContent = 'Mode: Tambah Data';
            document.getElementById('btn-cancel-edit').style.display = 'none';
            initializeForm();
        }
        
        function editData(id) {
            const item = productionData.find(data => data.id === id);
            if (!item) {
                showToast('Data tidak ditemukan', 'error');
                return;
            }
            
            // Isi form dengan data
            document.getElementById('edit-id').value = item.id;
            document.getElementById('order-number').value = item.orderNumber;
            document.getElementById('production-date').value = item.date;
            document.getElementById('product-name').value = item.productName;
            document.getElementById('composition').value = item.composition;
            document.getElementById('customer').value = item.customer || '';
            document.getElementById('target-quantity').value = item.target;
            document.getElementById('actual-output').value = item.actual;
            document.getElementById('reject-quantity').value = item.reject;
            document.getElementById('machine').value = item.machine;
            document.getElementById('operator').value = item.operator;
            document.getElementById('shift').value = item.shift;
            document.getElementById('status').value = item.status;
            document.getElementById('notes').value = item.notes || '';
            
            // Update status form
            document.getElementById('form-status').textContent = 'Mode: Edit Data';
            document.getElementById('form-status').style.color = 'var(--warning)';
            document.getElementById('btn-cancel-edit').style.display = 'block';
            
            // Scroll ke tab input data
            document.querySelector('[data-tab="input-data"]').click();
            showToast('Form siap untuk diedit', 'info');
        }
        
        function saveProductionData() {
            const editId = document.getElementById('edit-id').value;
            const orderNumber = document.getElementById('order-number').value.trim();
            const productionDate = document.getElementById('production-date').value;
            const productName = document.getElementById('product-name').value.trim();
            const composition = document.getElementById('composition').value.trim();
            const customer = document.getElementById('customer').value.trim();
            const targetQuantity = parseFloat(document.getElementById('target-quantity').value);
            const actualOutput = parseFloat(document.getElementById('actual-output').value);
            const rejectQuantity = parseFloat(document.getElementById('reject-quantity').value) || 0;
            const machine = document.getElementById('machine').value;
            const operator = document.getElementById('operator').value.trim();
            const shift = document.getElementById('shift').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value.trim();
            
            // Validasi
            if (actualOutput > targetQuantity) {
                showToast('Output aktual tidak boleh lebih besar dari target', 'error');
                return false;
            }
            
            if (rejectQuantity > actualOutput) {
                showToast('Jumlah reject tidak boleh lebih besar dari output aktual', 'error');
                return false;
            }
            
            if (productName.length < 3) {
                showToast('Nama produk harus minimal 3 karakter', 'error');
                return false;
            }
            
            const now = new Date().toISOString();
            
            if (editId) {
                // Edit data yang ada
                const index = productionData.findIndex(item => item.id === parseInt(editId));
                if (index !== -1) {
                    const efficiency = (actualOutput / targetQuantity) * 100;
                    
                    productionData[index] = {
                        ...productionData[index],
                        orderNumber,
                        date: productionDate,
                        productName,
                        composition,
                        customer,
                        target: targetQuantity,
                        actual: actualOutput,
                        reject: rejectQuantity,
                        machine,
                        operator,
                        shift,
                        status: status || (efficiency >= 90 ? 'completed' : efficiency >= 80 ? 'progress' : 'delayed'),
                        notes,
                        updatedAt: now
                    };
                    
                    showToast('Data berhasil diperbarui', 'success');
                }
            } else {
                // Tambah data baru
                const newId = productionData.length > 0 ? 
                    Math.max(...productionData.map(item => item.id)) + 1 : 1;
                
                const efficiency = (actualOutput / targetQuantity) * 100;
                
                productionData.unshift({
                    id: newId,
                    orderNumber,
                    date: productionDate,
                    productName,
                    composition,
                    customer,
                    target: targetQuantity,
                    actual: actualOutput,
                    reject: rejectQuantity,
                    machine,
                    operator,
                    shift,
                    status: status || (efficiency >= 90 ? 'completed' : efficiency >= 80 ? 'progress' : 'delayed'),
                    notes,
                    createdAt: now,
                    updatedAt: now
                });
                
                showToast('Data produksi berhasil disimpan', 'success');
            }
            
            saveData();
            clearForm();
            updateUI();
            return true;
        }
        
        function deleteData(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                productionData = productionData.filter(item => item.id !== id);
                saveData();
                updateUI();
                showToast('Data berhasil dihapus', 'success');
            }
        }
        
        function deleteSelectedItems() {
            if (selectedItems.size === 0) {
                showToast('Pilih data yang akan dihapus terlebih dahulu', 'warning');
                return;
            }
            
            if (confirm(`Apakah Anda yakin ingin menghapus ${selectedItems.size} data terpilih?`)) {
                productionData = productionData.filter(item => !selectedItems.has(item.id));
                selectedItems.clear();
                saveData();
                updateUI();
                showToast(`${selectedItems.size} data berhasil dihapus`, 'success');
            }
        }
        
        // UI Updates
        function updateUI() {
            updateDataCount();
            updateDashboard();
            updateDataTable();
            updateQuickStats();
        }
        
        function updateDataCount() {
            document.getElementById('total-data-count').textContent = productionData.length;
        }
        
        function updateDashboard() {
            if (productionData.length === 0) {
                resetDashboard();
                return;
            }
            
            const currentYearData = productionData.filter(item => 
                new Date(item.date).getFullYear() === selectedYear
            );
            
            const previousYearData = productionData.filter(item => 
                new Date(item.date).getFullYear() === selectedYear - 1
            );
            
            // Calculate metrics
            const totalOutput = currentYearData.reduce((sum, item) => sum + item.actual, 0);
            const totalTarget = currentYearData.reduce((sum, item) => sum + item.target, 0);
            const totalReject = currentYearData.reduce((sum, item) => sum + item.reject, 0);
            const avgEfficiency = totalTarget > 0 ? (totalOutput / totalTarget) * 100 : 0;
            const rejectRate = totalOutput > 0 ? (totalReject / totalOutput) * 100 : 0;
            
            // Previous year metrics
            const prevTotalOutput = previousYearData.reduce((sum, item) => sum + item.actual, 0);
            const prevAvgEfficiency = previousYearData.reduce((sum, item) => sum + (item.actual / item.target * 100), 0) / (previousYearData.length || 1);
            const prevRejectRate = previousYearData.reduce((sum, item) => sum + item.reject, 0) / (previousYearData.reduce((sum, item) => sum + item.actual, 0) || 1) * 100;
            
            // Update dashboard cards
            document.getElementById('total-output-year').textContent = formatNumber(totalOutput) + ' m';
            document.getElementById('avg-efficiency').textContent = avgEfficiency.toFixed(1) + '%';
            document.getElementById('reject-rate-year').textContent = rejectRate.toFixed(1) + '%';
            
            // Find top machine
            const machineOutputs = {};
            currentYearData.forEach(item => {
                machineOutputs[item.machine] = (machineOutputs[item.machine] || 0) + item.actual;
            });
            
            let topMachine = '-';
            let maxOutput = 0;
            for (const [machine, output] of Object.entries(machineOutputs)) {
                if (output > maxOutput) {
                    maxOutput = output;
                    topMachine = machine;
                }
            }
            
            document.getElementById('top-machine').textContent = topMachine;
            document.getElementById('machine-output').textContent = `Output: ${formatNumber(maxOutput)} m`;
            
            // Update trends
            const outputChange = prevTotalOutput > 0 ? ((totalOutput - prevTotalOutput) / prevTotalOutput * 100).toFixed(1) : 0;
            const efficiencyChange = (avgEfficiency - prevAvgEfficiency).toFixed(1);
            const rejectChange = (prevRejectRate - rejectRate).toFixed(1);
            
            updateTrendElement('output-trend', outputChange);
            updateTrendElement('efficiency-trend', efficiencyChange);
            updateTrendElement('reject-trend', rejectChange);
            
            // Update charts
            updateCharts();
        }
        
        function resetDashboard() {
            document.getElementById('total-output-year').textContent = '0';
            document.getElementById('avg-efficiency').textContent = '0%';
            document.getElementById('reject-rate-year').textContent = '0%';
            document.getElementById('top-machine').textContent = '-';
            document.getElementById('machine-output').textContent = 'Output: 0 m';
            
            document.getElementById('output-trend').innerHTML = '<i class="fas fa-minus"></i> 0%';
            document.getElementById('efficiency-trend').innerHTML = '<i class="fas fa-minus"></i> 0%';
            document.getElementById('reject-trend').innerHTML = '<i class="fas fa-minus"></i> 0%';
        }
        
        function updateTrendElement(elementId, change) {
            const element = document.getElementById(elementId);
            const isPositive = parseFloat(change) >= 0;
            
            element.innerHTML = `
                <i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i>
                ${Math.abs(change)}%
            `;
            element.className = isPositive ? 'trend-up' : 'trend-down';
        }
        
        function updateQuickStats() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            const todayData = productionData.filter(item => item.date === today);
            const monthData = productionData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getMonth() + 1 === currentMonth && itemDate.getFullYear() === currentYear;
            });
            const pendingData = productionData.filter(item => item.status === 'progress');
            
            document.getElementById('total-data').textContent = productionData.length;
            document.getElementById('today-data').textContent = todayData.length;
            document.getElementById('month-data').textContent = monthData.length;
            document.getElementById('pending-data').textContent = pendingData.length;
        }
        
        function updateDataTable() {
            const tbody = document.getElementById('data-table-body');
            const pagination = document.getElementById('pagination-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filter = document.getElementById('filter-data').value;
            
            let filteredData = [...productionData];
            
            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.orderNumber.toLowerCase().includes(searchTerm) ||
                    item.productName.toLowerCase().includes(searchTerm) ||
                    item.customer.toLowerCase().includes(searchTerm) ||
                    item.operator.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply time filter
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            
            switch(filter) {
                case 'today':
                    filteredData = filteredData.filter(item => item.date === today);
                    break;
                case 'week':
                    filteredData = filteredData.filter(item => new Date(item.date) >= weekAgo);
                    break;
                case 'month':
                    filteredData = filteredData.filter(item => new Date(item.date) >= monthAgo);
                    break;
            }
            
            // Sort by date (newest first)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredData.length / CONFIG.itemsPerPage);
            const startIndex = (currentPage - 1) * CONFIG.itemsPerPage;
            const pageData = filteredData.slice(startIndex, startIndex + CONFIG.itemsPerPage);
            
            // Update table
            tbody.innerHTML = '';
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 30px; color: #666;">
                            Tidak ada data produksi
                        </td>
                    </tr>
                `;
            } else {
                pageData.forEach(item => {
                    const efficiency = (item.actual / item.target) * 100;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="select-item" data-id="${item.id}" 
                                   ${selectedItems.has(item.id) ? 'checked' : ''}>
                        </td>
                        <td><strong>${item.orderNumber}</strong></td>
                        <td>${formatDate(item.date)}</td>
                        <td title="${item.productName}">${truncateText(item.productName, 20)}</td>
                        <td>${formatNumber(item.target)} m</td>
                        <td>${formatNumber(item.actual)} m</td>
                        <td>
                            <span style="color: ${getEfficiencyColor(efficiency)}; font-weight: 600;">
                                ${efficiency.toFixed(1)}%
                            </span>
                        </td>
                        <td>${item.machine}</td>
                        <td>
                            <span class="status-badge status-${item.status}">
                                ${getStatusText(item.status)}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="viewDetail(${item.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-warning btn-small" onclick="editData(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteData(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Update pagination
            updatePagination(totalPages, pagination, filteredData.length);
        }
        
        function updatePagination(totalPages, container, totalItems) {
            container.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateDataTable();
                }
            };
            container.appendChild(prevBtn);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => {
                    currentPage = i;
                    updateDataTable();
                };
                container.appendChild(btn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateDataTable();
                }
            };
            container.appendChild(nextBtn);
            
            // Info
            const info = document.createElement('span');
            info.style.marginLeft = '10px';
            info.textContent = `Halaman ${currentPage} dari ${totalPages} (${totalItems} data)`;
            container.appendChild(info);
        }
        
        // Chart Functions
        function updateCharts() {
            createMonthlyOutputChart();
            createMachineDistributionChart();
            createEfficiencyTrendChart();
        }
        
        function createMonthlyOutputChart() {
            const ctx = document.getElementById('monthly-output-chart').getContext('2d');
            const chartType = document.getElementById('chart-type').value;
            
            if (chartInstances.monthlyOutput) {
                chartInstances.monthlyOutput.destroy();
            }
            
            // Prepare monthly data
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthlyData = new Array(12).fill(0);
            
            productionData.forEach(item => {
                if (new Date(item.date).getFullYear() === selectedYear) {
                    const month = new Date(item.date).getMonth();
                    monthlyData[month] += item.actual;
                }
            });
            
            chartInstances.monthlyOutput = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: months,
                    datasets: [{
                        label: `Output ${selectedYear} (meter)`,
                        data: monthlyData,
                        backgroundColor: chartType === 'bar' ? 'rgba(52, 152, 219, 0.7)' : 'transparent',
                        borderColor: 'rgb(52, 152, 219)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${formatNumber(context.parsed.y)} m`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Output (meter)' },
                            ticks: { callback: (value) => formatNumber(value) + ' m' }
                        }
                    }
                }
            });
        }
        
        function createMachineDistributionChart() {
            const ctx = document.getElementById('machine-distribution-chart').getContext('2d');
            
            if (chartInstances.machineDistribution) {
                chartInstances.machineDistribution.destroy();
            }
            
            // Calculate machine outputs
            const machineOutputs = {};
            MACHINES.forEach(machine => {
                machineOutputs[machine] = 0;
            });
            
            productionData.forEach(item => {
                if (machineOutputs.hasOwnProperty(item.machine)) {
                    machineOutputs[item.machine] += item.actual;
                }
            });
            
            // Get top 6 machines
            const topMachines = Object.entries(machineOutputs)
                .filter(([, output]) => output > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            chartInstances.machineDistribution = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: topMachines.map(([machine]) => machine),
                    datasets: [{
                        data: topMachines.map(([, output]) => output),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(52, 73, 94, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const total = topMachines.reduce((sum, [, output]) => sum + output, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatNumber(value)} m (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createEfficiencyTrendChart() {
            const ctx = document.getElementById('efficiency-trend-chart').getContext('2d');
            
            if (chartInstances.efficiencyTrend) {
                chartInstances.efficiencyTrend.destroy();
            }
            
            // Calculate monthly efficiency
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthlyEfficiency = new Array(12).fill(0);
            const monthlyCount = new Array(12).fill(0);
            
            productionData.forEach(item => {
                if (new Date(item.date).getFullYear() === selectedYear) {
                    const month = new Date(item.date).getMonth();
                    const efficiency = (item.actual / item.target) * 100;
                    monthlyEfficiency[month] += efficiency;
                    monthlyCount[month]++;
                }
            });
            
            const avgEfficiency = monthlyEfficiency.map((sum, i) => 
                monthlyCount[i] > 0 ? sum / monthlyCount[i] : 0
            );
            
            chartInstances.efficiencyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Efisiensi Rata-rata',
                        data: avgEfficiency,
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderColor: 'rgb(46, 204, 113)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 70,
                            max: 100,
                            title: { display: true, text: 'Efisiensi (%)' },
                            ticks: { callback: (value) => value + '%' }
                        }
                    }
                }
            });
        }
        
        // Analysis Functions
        function generateAnalysis() {
            createAnnualTrendChart();
            createMachineAnalysisChart();
            createSeasonalChart();
            updateAnalysisResults();
        }
        
        function createAnnualTrendChart() {
            const ctx = document.getElementById('annual-trend-chart').getContext('2d');
            const analysisType = document.getElementById('analysis-type').value;
            
            if (chartInstances.annualTrend) {
                chartInstances.annualTrend.destroy();
            }
            
            // Calculate yearly data for last 4 years
            const years = [selectedYear - 3, selectedYear - 2, selectedYear - 1, selectedYear];
            const yearlyData = [];
            
            years.forEach(year => {
                const yearData = productionData.filter(item => 
                    new Date(item.date).getFullYear() === year
                );
                
                let value = 0;
                if (analysisType === 'output') {
                    value = yearData.reduce((sum, item) => sum + item.actual, 0);
                } else if (analysisType === 'efficiency') {
                    const totalEfficiency = yearData.reduce((sum, item) => 
                        sum + (item.actual / item.target * 100), 0);
                    value = yearData.length > 0 ? totalEfficiency / yearData.length : 0;
                } else if (analysisType === 'reject') {
                    const totalOutput = yearData.reduce((sum, item) => sum + item.actual, 0);
                    const totalReject = yearData.reduce((sum, item) => sum + item.reject, 0);
                    value = totalOutput > 0 ? (totalReject / totalOutput) * 100 : 0;
                }
                
                yearlyData.push(value);
            });
            
            chartInstances.annualTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: getAnalysisLabel(analysisType),
                        data: yearlyData,
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderColor: 'rgb(52, 152, 219)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const suffix = analysisType === 'output' ? ' m' : '%';
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}${suffix}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: analysisType === 'output',
                            title: { 
                                display: true, 
                                text: getAnalysisLabel(analysisType) 
                            }
                        }
                    }
                }
            });
        }
        
        function createMachineAnalysisChart() {
            const ctx = document.getElementById('machine-analysis-chart').getContext('2d');
            
            if (chartInstances.machineAnalysis) {
                chartInstances.machineAnalysis.destroy();
            }
            
            // Calculate machine performance metrics
            const machineMetrics = {};
            
            MACHINES.forEach(machine => {
                const machineData = productionData.filter(item => 
                    item.machine === machine && new Date(item.date).getFullYear() === selectedYear
                );
                
                if (machineData.length > 0) {
                    const totalOutput = machineData.reduce((sum, item) => sum + item.actual, 0);
                    const avgEfficiency = machineData.reduce((sum, item) => 
                        sum + (item.actual / item.target * 100), 0) / machineData.length;
                    const avgRejectRate = machineData.reduce((sum, item) => 
                        sum + (item.reject / item.actual * 100), 0) / machineData.length;
                    
                    machineMetrics[machine] = {
                        output: totalOutput,
                        efficiency: avgEfficiency,
                        rejectRate: avgRejectRate
                    };
                }
            });
            
            // Get top machines by output
            const topMachines = Object.entries(machineMetrics)
                .sort((a, b) => b[1].output - a[1].output)
                .slice(0, 5);
            
            chartInstances.machineAnalysis = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topMachines.map(([machine]) => machine),
                    datasets: [
                        {
                            label: 'Output (ribu m)',
                            data: topMachines.map(([, metrics]) => metrics.output / 1000),
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Efisiensi (%)',
                            data: topMachines.map(([, metrics]) => metrics.efficiency),
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            yAxisID: 'y1',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Output (ribu m)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Efisiensi (%)' },
                            min: 70,
                            max: 100,
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function createSeasonalChart() {
            const ctx = document.getElementById('seasonal-chart').getContext('2d');
            
            if (chartInstances.seasonal) {
                chartInstances.seasonal.destroy();
            }
            
            // Calculate seasonal pattern (last 3 years)
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
            const seasonalData = new Array(12).fill(0);
            const yearCount = new Array(12).fill(0);
            
            for (let year = selectedYear - 2; year <= selectedYear; year++) {
                for (let month = 0; month < 12; month++) {
                    const monthData = productionData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate.getFullYear() === year && itemDate.getMonth() === month;
                    });
                    
                    if (monthData.length > 0) {
                        const monthOutput = monthData.reduce((sum, item) => sum + item.actual, 0);
                        seasonalData[month] += monthOutput;
                        yearCount[month]++;
                    }
                }
            }
            
            const avgSeasonalData = seasonalData.map((sum, i) => 
                yearCount[i] > 0 ? sum / yearCount[i] : 0
            );
            
            chartInstances.seasonal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Pola Musiman Output',
                        data: avgSeasonalData,
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderColor: 'rgb(155, 89, 182)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Output Rata-rata (m)' },
                            ticks: { callback: (value) => formatNumber(value) + ' m' }
                        }
                    }
                }
            });
        }
        
        function updateAnalysisResults() {
            const container = document.getElementById('analysis-results');
            
            // Calculate key metrics
            const yearData = productionData.filter(item => 
                new Date(item.date).getFullYear() === selectedYear
            );
            
            if (yearData.length === 0) {
                container.innerHTML = '<p>Tidak ada data untuk dianalisis</p>';
                return;
            }
            
            const totalOutput = yearData.reduce((sum, item) => sum + item.actual, 0);
            const totalTarget = yearData.reduce((sum, item) => sum + item.target, 0);
            const totalReject = yearData.reduce((sum, item) => sum + item.reject, 0);
            const avgEfficiency = (totalOutput / totalTarget) * 100;
            const rejectRate = (totalReject / totalOutput) * 100;
            
            // Machine analysis
            const machineStats = {};
            yearData.forEach(item => {
                if (!machineStats[item.machine]) {
                    machineStats[item.machine] = { output: 0, count: 0 };
                }
                machineStats[item.machine].output += item.actual;
                machineStats[item.machine].count++;
            });
            
            const topMachine = Object.entries(machineStats)
                .reduce((a, b) => a[1].output > b[1].output ? a : b);
            
            // Monthly analysis
            const monthlyOutput = new Array(12).fill(0);
            yearData.forEach(item => {
                const month = new Date(item.date).getMonth();
                monthlyOutput[month] += item.actual;
            });
            
            const bestMonth = monthlyOutput.indexOf(Math.max(...monthlyOutput));
            const worstMonth = monthlyOutput.indexOf(Math.min(...monthlyOutput.filter(v => v > 0)));
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                    <div>
                        <h3>Ringkasan Performa ${selectedYear}</h3>
                        <p><strong>Total Output:</strong> ${formatNumber(totalOutput)} meter</p>
                        <p><strong>Target Pencapaian:</strong> ${((totalOutput / totalTarget) * 100).toFixed(1)}%</p>
                        <p><strong>Efisiensi Rata-rata:</strong> ${avgEfficiency.toFixed(1)}%</p>
                        <p><strong>Tingkat Reject:</strong> ${rejectRate.toFixed(2)}%</p>
                        <p><strong>Mesin Terproduktif:</strong> ${topMachine[0]} (${formatNumber(topMachine[1].output)} m)</p>
                    </div>
                    <div>
                        <h3>Analisis Bulanan</h3>
                        <p><strong>Bulan Terbaik:</strong> ${monthNames[bestMonth]} (${formatNumber(monthlyOutput[bestMonth])} m)</p>
                        <p><strong>Bulan Tersulit:</strong> ${worstMonth >= 0 ? monthNames[worstMonth] : '-'} ${worstMonth >= 0 ? `(${formatNumber(monthlyOutput[worstMonth])} m)` : ''}</p>
                        <p><strong>Rata-rata Output Bulanan:</strong> ${formatNumber(totalOutput / 12)} m</p>
                        <p><strong>Produktivitas Harian:</strong> ${formatNumber(totalOutput / 365)} m/hari</p>
                        <p><strong>Total Order:</strong> ${yearData.length} order</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Rekomendasi Perbaikan</h3>
                    <ul>
                        ${avgEfficiency < 90 ? '<li> Tingkatkan efisiensi produksi menuju target 90%</li>' : ''}
                        ${rejectRate > 3 ? '<li> Kurangi tingkat reject di bawah 3%</li>' : ''}
                        ${worstMonth >= 0 && monthlyOutput[worstMonth] < (totalOutput / 12 * 0.7) ? 
                          `<li> Analisis penyebab rendahnya output di bulan ${monthNames[worstMonth]}</li>` : ''}
                        <li> Optimalkan penggunaan mesin ${topMachine[0]} sebagai benchmark</li>
                        <li> Lakukan preventive maintenance berkala pada semua mesin</li>
                    </ul>
                </div>
            `;
        }
        
        // Forecast Functions
        function generateForecast() {
            createForecastChart();
            updateForecastRecommendations();
            document.getElementById('forecast-modal').style.display = 'flex';
        }
        
        function createForecastChart() {
            const ctx = document.getElementById('forecast-chart').getContext('2d');
            
            if (chartInstances.forecast) {
                chartInstances.forecast.destroy();
            }
            
            // Simple linear forecast based on last 6 months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthlyOutput = new Array(12).fill(0);
            
            productionData.forEach(item => {
                if (new Date(item.date).getFullYear() === selectedYear) {
                    const month = new Date(item.date).getMonth();
                    monthlyOutput[month] += item.actual;
                }
            });
            
            // Calculate forecast (simple moving average)
            const forecast = [];
            const last6Months = monthlyOutput.slice(-6).filter(v => v > 0);
            const avgLast6Months = last6Months.reduce((a, b) => a + b, 0) / last6Months.length;
            
            for (let i = 0; i < 12; i++) {
                if (monthlyOutput[i] > 0) {
                    forecast.push(monthlyOutput[i]);
                } else {
                    forecast.push(avgLast6Months * (1 + (i * 0.02))); // 2% growth per month
                }
            }
            
            chartInstances.forecast = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Data Aktual',
                            data: monthlyOutput,
                            borderColor: 'rgb(52, 152, 219)',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Forecast',
                            data: forecast,
                            borderColor: 'rgb(231, 76, 60)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Output (meter)' },
                            ticks: { callback: (value) => formatNumber(value) + ' m' }
                        }
                    }
                }
            });
        }
        
        function updateForecastRecommendations() {
            const container = document.getElementById('forecast-recommendations');
            
            const yearData = productionData.filter(item => 
                new Date(item.date).getFullYear() === selectedYear
            );
            
            const totalOutput = yearData.reduce((sum, item) => sum + item.actual, 0);
            const avgMonthly = totalOutput / 12;
            
            container.innerHTML = `
                <p><strong>Proyeksi Output Tahun ${selectedYear + 1}:</strong> ${formatNumber(totalOutput * 1.15)} meter (+15%)</p>
                <p><strong>Target Bulanan:</strong> ${formatNumber(avgMonthly * 1.15)} meter/bulan</p>
                <p><strong>Recomendasi Kapasitas:</strong></p>
                <ul>
                    <li>Pertahankan operasi mesin selama 22 hari/bulan</li>
                    <li>Tingkatkan efisiensi dari ${((totalOutput / yearData.reduce((sum, item) => sum + item.target, 0)) * 100).toFixed(1)}% menjadi 92%</li>
                    <li>Kurangi downtime mesin hingga 5%</li>
                    <li>Tambah 1 shift produksi di bulan peak season</li>
                </ul>
            `;
        }
        
        // Utility Functions
        function formatNumber(num) {
            return num.toLocaleString('id-ID');
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        function getEfficiencyColor(efficiency) {
            if (efficiency >= 90) return '#27ae60';
            if (efficiency >= 80) return '#f39c12';
            return '#e74c3c';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'completed': 'Selesai',
                'progress': 'Dalam Proses',
                'delayed': 'Terlambat'
            };
            return statusMap[status] || status;
        }
        
        function getAnalysisLabel(type) {
            const labels = {
                'output': 'Output Produksi (meter)',
                'efficiency': 'Efisiensi (%)',
                'reject': 'Reject Rate (%)'
            };
            return labels[type] || type;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        function viewDetail(id) {
            const item = productionData.find(data => data.id === id);
            if (!item) return;
            
            const efficiency = (item.actual / item.target) * 100;
            const rejectRate = item.actual > 0 ? (item.reject / item.actual) * 100 : 0;
            
            document.getElementById('modal-detail-content').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Nomor Order:</strong> ${item.orderNumber}</p>
                        <p><strong>Tanggal Produksi:</strong> ${formatDate(item.date)}</p>
                        <p><strong>Shift:</strong> ${item.shift}</p>
                        <p><strong>Nama Produk:</strong> ${item.productName}</p>
                    </div>
                    <div>
                        <p><strong>Customer:</strong> ${item.customer || '-'}</p>
                        <p><strong>Operator:</strong> ${item.operator}</p>
                        <p><strong>Mesin:</strong> ${item.machine}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>Komposisi Material:</strong></p>
                    <p style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${item.composition}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Target Produksi:</strong> ${formatNumber(item.target)} m</p>
                        <p><strong>Output Aktual:</strong> ${formatNumber(item.actual)} m</p>
                        <p><strong>Reject/Waste:</strong> ${formatNumber(item.reject)} m</p>
                    </div>
                    <div>
                        <p><strong>Efisiensi:</strong> <span style="color: ${getEfficiencyColor(efficiency)}; font-weight: 600;">${efficiency.toFixed(1)}%</span></p>
                        <p><strong>Reject Rate:</strong> ${rejectRate.toFixed(2)}%</p>
                        <p><strong>Selisih:</strong> ${formatNumber(item.target - item.actual)} m</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>Catatan:</strong></p>
                    <p style="background: #f8f9fa; padding: 10px; border-radius: 5px;">${item.notes || 'Tidak ada catatan'}</p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-warning" onclick="editData(${item.id}); document.getElementById('detail-modal').style.display='none';">
                        <i class="fas fa-edit"></i> Edit Data
                    </button>
                    <button class="btn btn-danger" onclick="deleteData(${item.id}); document.getElementById('detail-modal').style.display='none';">
                        <i class="fas fa-trash"></i> Hapus Data
                    </button>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'flex';
        }
        
        function createMultiYearComparison() {
            const ctx = document.getElementById('multi-year-comparison-chart').getContext('2d');
            
            // Calculate output for last 4 years
            const years = [selectedYear - 3, selectedYear - 2, selectedYear - 1, selectedYear];
            const outputs = years.map(year => {
                const yearData = productionData.filter(item => 
                    new Date(item.date).getFullYear() === year
                );
                return yearData.reduce((sum, item) => sum + item.actual, 0);
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years.map(y => y.toString()),
                    datasets: [{
                        label: 'Output Tahunan (meter)',
                        data: outputs,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Output (meter)' },
                            ticks: { callback: (value) => formatNumber(value) + ' m' }
                        }
                    }
                }
            });
        }
        
        // Export Functions
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: All Production Data
                const sheetData = productionData.map(item => ({
                    'No. Order': item.orderNumber,
                    'Tanggal': formatDate(item.date),
                    'Produk': item.productName,
                    'Komposisi': item.composition,
                    'Customer': item.customer,
                    'Target (m)': item.target,
                    'Aktual (m)': item.actual,
                    'Reject (m)': item.reject,
                    'Efisiensi (%)': ((item.actual / item.target) * 100).toFixed(1),
                    'Mesin': item.machine,
                    'Operator': item.operator,
                    'Shift': item.shift,
                    'Status': getStatusText(item.status),
                    'Catatan': item.notes
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws1, 'Data Produksi');
                
                // Sheet 2: Summary
                const yearData = productionData.filter(item => 
                    new Date(item.date).getFullYear() === selectedYear
                );
                
                const totalOutput = yearData.reduce((sum, item) => sum + item.actual, 0);
                const totalTarget = yearData.reduce((sum, item) => sum + item.target, 0);
                const totalReject = yearData.reduce((sum, item) => sum + item.reject, 0);
                
                const summaryData = [{
                    'Tahun': selectedYear,
                    'Total Output (m)': totalOutput,
                    'Total Target (m)': totalTarget,
                    'Pencapaian Target (%)': ((totalOutput / totalTarget) * 100).toFixed(1),
                    'Total Reject (m)': totalReject,
                    'Reject Rate (%)': ((totalReject / totalOutput) * 100).toFixed(2),
                    'Jumlah Order': yearData.length,
                    'Rata-rata Efisiensi (%)': yearData.length > 0 ? 
                        (yearData.reduce((sum, item) => sum + (item.actual / item.target * 100), 0) / yearData.length).toFixed(1) : 0
                }];
                
                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Ringkasan');
                
                // Save file
                const fileName = `Laporan_Produksi_${selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Laporan Excel berhasil diexport', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Gagal mengexport ke Excel', 'error');
            }
        }
        
        function exportAnalysisToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Calculate analysis data
                const years = [selectedYear - 3, selectedYear - 2, selectedYear - 1, selectedYear];
                const analysisData = years.map(year => {
                    const yearData = productionData.filter(item => 
                        new Date(item.date).getFullYear() === year
                    );
                    
                    const output = yearData.reduce((sum, item) => sum + item.actual, 0);
                    const target = yearData.reduce((sum, item) => sum + item.target, 0);
                    const reject = yearData.reduce((sum, item) => sum + item.reject, 0);
                    const efficiency = target > 0 ? (output / target) * 100 : 0;
                    const rejectRate = output > 0 ? (reject / output) * 100 : 0;
                    
                    return {
                        'Tahun': year,
                        'Output (m)': output,
                        'Target (m)': target,
                        'Pencapaian (%)': ((output / target) * 100).toFixed(1),
                        'Efisiensi (%)': efficiency.toFixed(1),
                        'Reject (m)': reject,
                        'Reject Rate (%)': rejectRate.toFixed(2),
                        'Jumlah Order': yearData.length
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(analysisData);
                XLSX.utils.book_append_sheet(wb, ws, 'Analisis Tahunan');
                
                const fileName = `Analisis_Produksi_${selectedYear}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Analisis berhasil diexport ke Excel', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Gagal mengexport analisis', 'error');
            }
        }
        
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Title
                doc.setFontSize(16);
                doc.text(`Laporan Produksi ${selectedYear}`, 105, 15, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`PT. Kemasan Fleksibel Indonesia`, 105, 25, { align: 'center' });
                
                // Summary Table
                const yearData = productionData.filter(item => 
                    new Date(item.date).getFullYear() === selectedYear
                );
                
                const totalOutput = yearData.reduce((sum, item) => sum + item.actual, 0);
                const totalTarget = yearData.reduce((sum, item) => sum + item.target, 0);
                const totalReject = yearData.reduce((sum, item) => sum + item.reject, 0);
                
                const summaryData = [
                    ['Total Output', `${formatNumber(totalOutput)} m`],
                    ['Total Target', `${formatNumber(totalTarget)} m`],
                    ['Pencapaian', `${((totalOutput / totalTarget) * 100).toFixed(1)}%`],
                    ['Total Reject', `${formatNumber(totalReject)} m`],
                    ['Reject Rate', `${((totalReject / totalOutput) * 100).toFixed(2)}%`],
                    ['Jumlah Order', yearData.length]
                ];
                
                doc.autoTable({
                    startY: 35,
                    head: [['Metric', 'Nilai']],
                    body: summaryData,
                    theme: 'striped'
                });
                
                // Add page for data table
                doc.addPage();
                doc.text('Data Produksi Detail', 105, 15, { align: 'center' });
                
                const tableData = yearData.slice(0, 50).map(item => [
                    item.orderNumber,
                    formatDate(item.date),
                    item.productName.substring(0, 20),
                    formatNumber(item.target),
                    formatNumber(item.actual),
                    `${((item.actual / item.target) * 100).toFixed(1)}%`,
                    item.machine
                ]);
                
                doc.autoTable({
                    startY: 25,
                    head: [['No. Order', 'Tanggal', 'Produk', 'Target', 'Aktual', 'Efisiensi', 'Mesin']],
                    body: tableData,
                    theme: 'grid'
                });
                
                // Save PDF
                doc.save(`Laporan_Produksi_${selectedYear}.pdf`);
                showToast('Laporan PDF berhasil diexport', 'success');
            } catch (error) {
                console.error('PDF export error:', error);
                showToast('Gagal mengexport ke PDF', 'error');
            }
        }
        
        // Event Listeners Setup
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
            
            // Year selector
            document.getElementById('year-select').addEventListener('change', function() {
                selectedYear = parseInt(this.value);
                updateDashboard();
                updateDataTable();
                generateAnalysis();
            });
            
            // Form submission
            document.getElementById('production-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProductionData();
            });
            
            // Form buttons
            document.getElementById('btn-cancel-edit').addEventListener('click', clearForm);
            document.getElementById('btn-clear-form').addEventListener('click', clearForm);
            
            // Dashboard controls
            document.getElementById('btn-refresh').addEventListener('click', function() {
                updateUI();
                showToast('Data berhasil direfresh', 'success');
            });
            
            document.getElementById('btn-export-excel').addEventListener('click', exportToExcel);
            document.getElementById('btn-export-pdf').addEventListener('click', exportToPDF);
            
            document.getElementById('btn-comparison').addEventListener('click', function() {
                createMultiYearComparison();
                document.getElementById('comparison-modal').style.display = 'flex';
            });
            
            document.getElementById('btn-reset-filters').addEventListener('click', function() {
                document.getElementById('search-input').value = '';
                document.getElementById('filter-data').value = 'all';
                currentPage = 1;
                selectedItems.clear();
                updateDataTable();
                showToast('Filter berhasil direset', 'info');
            });
            
            // Data table controls
            document.getElementById('btn-search-data').addEventListener('click', updateDataTable);
            document.getElementById('search-input').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') updateDataTable();
            });
            
            document.getElementById('filter-data').addEventListener('change', function() {
                currentPage = 1;
                updateDataTable();
            });
            
            document.getElementById('select-all').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.select-item');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    const id = parseInt(cb.dataset.id);
                    if (this.checked) {
                        selectedItems.add(id);
                    } else {
                        selectedItems.delete(id);
                    }
                });
            });
            
            document.getElementById('btn-bulk-delete').addEventListener('click', deleteSelectedItems);
            
            // Analysis controls
            document.getElementById('btn-generate-analysis').addEventListener('click', generateAnalysis);
            document.getElementById('btn-export-analysis').addEventListener('click', exportAnalysisToExcel);
            document.getElementById('btn-forecast').addEventListener('click', generateForecast);
            
            document.getElementById('chart-type').addEventListener('change', function() {
                createMonthlyOutputChart();
            });
            
            document.getElementById('analysis-type').addEventListener('change', function() {
                createAnnualTrendChart();
            });
            
            // Modal close buttons
            document.getElementById('close-detail-modal').addEventListener('click', function() {
                document.getElementById('detail-modal').style.display = 'none';
            });
            
            document.getElementById('close-comparison-modal').addEventListener('click', function() {
                document.getElementById('comparison-modal').style.display = 'none';
            });
            
            document.getElementById('close-forecast-modal').addEventListener('click', function() {
                document.getElementById('forecast-modal').style.display = 'none';
            });
            
            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('detail-modal')) {
                    document.getElementById('detail-modal').style.display = 'none';
                }
                if (e.target === document.getElementById('comparison-modal')) {
                    document.getElementById('comparison-modal').style.display = 'none';
                }
                if (e.target === document.getElementById('forecast-modal')) {
                    document.getElementById('forecast-modal').style.display = 'none';
                }
            });
            
            // Update last update time
            function updateLastUpdate() {
                const now = new Date();
                const formatted = now.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('last-update').textContent = formatted;
            }
            
            updateLastUpdate();
            setInterval(updateLastUpdate, 60000); // Update every minute
            
            // Handle checkbox changes in data table
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('select-item')) {
                    const id = parseInt(e.target.dataset.id);
                    if (e.target.checked) {
                        selectedItems.add(id);
                    } else {
                        selectedItems.delete(id);
                    }
                    
                    // Update select all checkbox
                    const checkboxes = document.querySelectorAll('.select-item');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    document.getElementById('select-all').checked = allChecked;
                }
            });
        }
        
        // Expose functions to global scope
        window.viewDetail = viewDetail;
        window.editData = editData;
        window.deleteData = deleteData;
    </script>
</body>
</html>